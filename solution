import vtk
import slicer

# Get the Slicer ROS2 logic and node
rosLogic = slicer.util.getModuleLogic('ROS2')
rosNode = rosLogic.GetDefaultROS2Node()

# Optional: list available subscriber types
rosNode.RegisteredROS2SubscriberNodes()

# Create subscriber for PoseArray
subShape = rosNode.CreateAndAddSubscriberNode('PoseArray', '/needle/state/current_shape')

# Add new fiducial node
fid = slicer.mrmlScene.AddNewNodeByClass('vtkMRMLMarkupsFiducialNode', 'PoseArrayPoints')

# Create a curve from the fiducials
markupsLogic = slicer.modules.markups.logic()
curveNode = markupsLogic.CreateCurveFromFiducials(fid)
curveNode.SetName("NeedleShapeZ")

# Callback function: convert PoseArray -> fiducials -> curve
def myCallback(caller=None, event=None):
    message = subShape.GetLastMessage()  # vtkTransformCollection
    num = message.GetNumberOfItems()     # Number of vtkTransform objects

    #Clear old fiducials before adding ne ones
    fid.RemoveAllMarkups()

    for i in range(num):
        transform = message.GetItemAsObject(i)  # vtkTransform
        m = vtk.vtkMatrix4x4()                  # Make the matrix
        transform.GetMatrix(m)
        x, y, z = m.GetElement(0, 3), m.GetElement(1, 3), m.GetElement(2, 3)
        fid.AddFiducial(x, y, z)

# Add the observer with callback
observerId = subShape.AddObserver('ModifiedEvent', myCallback)
